name: Build and Deploy to GKE

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: devops-advance-477506
  REGION: us-central1
  ZONE: us-central1-a
  REPO_NAME: devops-advance-dev-repo
  CLUSTER_NAME: devops-advance-dev-gke
  GKE_NAMESPACE: demo

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Backend
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/demo-backend:latest ./app/backend
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/demo-backend:latest

      - name: Build and Push Frontend
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/demo-frontend:latest ./app/frontend
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/demo-frontend:latest

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
            --zone ${{ env.ZONE }} --project ${{ env.PROJECT_ID }}

      - name: Install GKE auth plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin || true

      - name: Apply Kubernetes manifests
        run: |
          kubectl -n ${{ env.GKE_NAMESPACE }} apply -f app/backend/k8s/
          kubectl -n ${{ env.GKE_NAMESPACE }} apply -f app/frontend/k8s/
          kubectl -n ${{ env.GKE_NAMESPACE }} rollout restart deployment demo-backend
          kubectl -n ${{ env.GKE_NAMESPACE }} rollout restart deployment demo-frontend